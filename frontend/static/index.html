<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomous Supply Chain Control Tower</title>
    <meta name="theme-color" content="#08090A">

    <link rel="stylesheet" href="/static/styles.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body x-data="appState()">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         STICKY RESULTS BAR (builds up as data arrives)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="results-header" :class="{'visible': visionResult !== null}">
        <div class="results-header-content">
            <div class="result-item">
                <span class="result-label">Count</span>
                <span class="result-value highlight" x-text="visionResult?.item_count || 'â€”'"></span>
            </div>
            <div class="result-item">
                <span class="result-label">Type</span>
                <span class="result-value" x-text="visionResult?.item_type || 'â€”'"></span>
            </div>
            <div class="result-item">
                <span class="result-label">Confidence</span>
                <span class="result-value" x-text="visionResult?.confidence || 'â€”'"></span>
            </div>
            <div class="result-item" x-show="supplierResult">
                <span class="result-label">Supplier</span>
                <span class="result-value" x-text="supplierResult?.supplier || 'â€”'"></span>
            </div>
            <div class="result-item" x-show="orderResult">
                <span class="result-label">Order</span>
                <span class="result-value" style="color: var(--green);" x-text="orderResult?.orderId || 'â€”'"></span>
            </div>
        </div>
        <button @click="resetUpload()" class="btn btn-sm" style="background: var(--surface-3); color: var(--text-80);">
            New Analysis
        </button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         FIXED CONTROLS (top right)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="fixed-controls no-print">
        <button @click="toggleDemoMode()" class="demo-toggle" :class="{'active': demoMode}"
            :title="demoMode ? 'Demo Mode: ON (pauses at each stage)' : 'Demo Mode: OFF (auto-advances)'">
            <span x-text="demoMode ? 'DEMO' : 'AUTO'"></span>
        </button>
        <button @click="toggleAudio()" class="mute-toggle" :title="audioEnabled ? 'Mute' : 'Unmute'">
            <span x-show="audioEnabled">&#x1f50a;</span>
            <span x-show="!audioEnabled">&#x1f507;</span>
        </button>
        <div class="connection-status">
            <div class="connection-dot" :class="wsConnected ? 'connected' : 'disconnected'"></div>
            <span x-text="wsConnected ? 'Live' : 'Offline'"></span>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         HEADER (hidden when results header visible)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <header :class="{'header-hidden': visionResult}">
        <h1 class="hero-title">Autonomous Supply Chain Control Tower</h1>
        <p class="hero-subtitle">Gemini 3 Flash &middot; AlloyDB AI &middot; A2A Protocol</p>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MAIN CONTENT AREA
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="app-container" :class="{'has-panels': step > 0}">

        <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             LEFT PANELS (Agent Activity + Workflow)
             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="left-panels-container" x-show="step > 0" x-transition>

            <!-- Workflow timeline -->
            <div class="workflow-panel floating-status-card">
                <div class="progress-timeline">
                    <h3 class="panel-title">Workflow</h3>
                    <div class="timeline-steps">
                        <div class="timeline-step" :class="{'active': step >= 0, 'completed': step > 0}">
                            <div class="step-indicator"></div>
                            <span>Upload Image</span>
                        </div>
                        <div class="timeline-step" :class="{'active': step >= 1, 'completed': step > 1}">
                            <div class="step-indicator"></div>
                            <span>Vision Analysis</span>
                        </div>
                        <div class="timeline-step" :class="{'active': step >= 2, 'completed': step > 2}">
                            <div class="step-indicator"></div>
                            <span>Supplier Match</span>
                        </div>
                        <div class="timeline-step" :class="{'active': step >= 3, 'completed': step >= 4}">
                            <div class="step-indicator"></div>
                            <span>Place Order</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent activity -->
            <div class="agent-panel floating-status-card"
                :class="{'tint-vision': step === 1, 'tint-memory': step === 2, 'tint-action': step >= 3}">
                <h3 class="panel-title">Agent Activity</h3>
                <div class="agent-activity">
                    <div class="activity-text" x-text="orchestratorText || 'System ready'"></div>
                    <div class="activity-indicator" x-show="isProcessing">
                        <div class="pulse-dot"></div>
                        <div class="pulse-dot"></div>
                        <div class="pulse-dot"></div>
                    </div>
                </div>
            </div>

        </div> <!-- /left-panels-container -->

        <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             MAIN CARD (center column)
             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="main-glass-card">

            <!-- ACT 0: UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <section class="act act-upload" :class="{ 'active': step === 0 }" x-show="step === 0">

                <!-- Sample images FIRST â€” prominent, above fold -->
                <div x-show="sampleImages.length > 0 && !uploadedImage" class="samples-section">
                    <div class="samples-header">
                        <span class="samples-label">Quick start</span>
                        <div class="samples-line"></div>
                    </div>
                    <div class="samples-grid">
                        <template x-for="img in sampleImages" :key="img.name">
                            <div class="sample-card" @click="selectSampleImage(img.name)">
                                <img :src="`/api/test-image/${img.name}`" :alt="img.name" loading="eager">
                                <div class="sample-overlay">
                                    <span class="sample-action">Analyze this image</span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Upload area (compact) -->
                <div class="upload-area" :class="{'drag-over': isDragging, 'has-image': uploadedImage}"
                    @dragover.prevent="isDragging = true" @dragleave.prevent="isDragging = false"
                    @drop.prevent="handleDrop($event)">

                    <template x-if="!uploadedImage">
                        <label for="file-upload" class="upload-label">
                            <svg class="upload-icon" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path
                                    d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                    stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <span class="upload-text">
                                <span class="upload-link">Upload a file</span>
                                or drag and drop
                            </span>
                            <span class="upload-hint">PNG, JPG, JPEG up to 10MB</span>
                            <input id="file-upload" type="file" style="display: none;" accept="image/*"
                                @change="handleFileSelect($event)">
                        </label>
                    </template>

                    <template x-if="uploadedImage">
                        <div style="position: relative;">
                            <img :src="uploadedImage" alt="Uploaded warehouse image" class="uploaded-preview">
                            <button @click="resetUpload()" class="remove-image-btn">
                                <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </template>
                </div>

                <!-- Start button (only shows when image uploaded) -->
                <div class="text-center" x-show="uploadedImage" style="margin-top: var(--space-5);">
                    <button @click="startAnalysis()" :disabled="!uploadedImage || isProcessing"
                        class="btn btn-primary btn-lg">
                        <template x-if="!isProcessing">
                            <span>Initiate Autonomous Workflow</span>
                        </template>
                        <template x-if="isProcessing">
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="spinner"></span>
                                Processingâ€¦
                            </span>
                        </template>
                    </button>
                </div>

                <!-- Value proposition -->
                <div class="value-props" x-show="!uploadedImage">
                    <div class="value-prop">
                        <div class="prop-icon" style="color: var(--blue);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </div>
                        <div>
                            <div class="prop-title">Count with Gemini 3 Flash</div>
                            <div class="prop-desc">Code execution counts boxes via OpenCV</div>
                        </div>
                    </div>
                    <div class="value-prop">
                        <div class="prop-icon" style="color: var(--purple);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <circle cx="11" cy="11" r="8" />
                                <path d="M21 21l-4.35-4.35" />
                            </svg>
                        </div>
                        <div>
                            <div class="prop-title">Match via AlloyDB ScaNN</div>
                            <div class="prop-desc">Vector search across 1M+ supplier parts</div>
                        </div>
                    </div>
                    <div class="value-prop">
                        <div class="prop-icon" style="color: var(--green);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div>
                            <div class="prop-title">Order via A2A Protocol</div>
                            <div class="prop-desc">Agent-to-agent autonomous procurement</div>
                        </div>
                    </div>
                </div>

            </section>

            <!-- ACT 1: VISION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <section class="act act-vision" :class="{ 'active': step === 1 }" x-show="step === 1">
                <div class="image-stage">
                    <img :src="uploadedImage" alt="Analyzingâ€¦">

                    <!-- Scan line -->
                    <div class="scan-overlay" x-show="!visionResult">
                        <div class="scan-line"></div>
                    </div>

                    <!-- Thought stream -->
                    <div class="thought-overlay" x-show="currentThought && !visionResult">
                        <span class="thought-text" x-text="currentThought"></span>
                        <span class="thought-cursor"></span>
                    </div>

                    <!-- Bounding boxes overlay (Gemini spatial understanding) -->
                    <div class="bbox-overlay" x-show="visionResult && boundingBoxes.length > 0">
                        <template x-for="(box, idx) in boundingBoxes" :key="idx">
                            <div class="bbox-rect"
                                :style="`top: ${box.box_2d[0] / 10}%; left: ${box.box_2d[1] / 10}%; height: ${(box.box_2d[2] - box.box_2d[0]) / 10}%; width: ${(box.box_2d[3] - box.box_2d[1]) / 10}%; animation-delay: ${idx * 60}ms;`">
                                <span class="bbox-label" x-text="box.label"></span>
                            </div>
                        </template>
                    </div>

                    <!-- Result badge -->
                    <div x-show="visionResult" class="result-container">
                        <div class="count-badge">
                            <div class="badge-indicator"
                                :class="{'confirmed': visionResult?.hasCodeExecution, 'estimated': !visionResult?.hasCodeExecution}">
                                <span x-show="visionResult?.hasCodeExecution">&#10003;</span>
                                <span x-show="!visionResult?.hasCodeExecution">~</span>
                            </div>
                            <div class="badge-content">
                                <div class="badge-count"
                                    x-text="visionResult ? `${visionResult.item_count} ${visionResult.item_type}` : ''">
                                </div>
                                <div class="badge-label"
                                    x-text="visionResult?.hasCodeExecution ? 'Code-Verified' : 'Calculated'"></div>
                            </div>
                        </div>
                        <div class="count-summary" x-text="visionResult ? visionResult.summary : ''"></div>
                    </div>
                </div>
            </section>

            <!-- ACT 2: SUPPLIER MATCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <section class="act act-memory" :class="{ 'active': step === 2 }" x-show="step === 2">
                <!-- Transition header -->
                <div class="act-transition-header">
                    <div class="transition-badge vision-done">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M9 12l2 2 4-4" />
                        </svg>
                        <span
                            x-text="visionResult ? `${visionResult.item_count} ${visionResult.item_type} detected` : ''"></span>
                    </div>
                    <div class="transition-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5">
                            <path d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                    </div>
                    <div class="transition-badge supplier-active">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="11" cy="11" r="8" />
                            <path d="M21 21l-4.35-4.35" />
                        </svg>
                        <span>Finding supplier match</span>
                    </div>
                </div>

                <!-- Supplier search visualization -->
                <div class="supplier-search-container">
                    <!-- Searching state -->
                    <div class="vector-search-viz" x-show="!supplierResult">
                        <div class="search-animation-container">
                            <div class="db-icon-container">
                                <svg class="db-icon" width="48" height="48" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="1">
                                    <ellipse cx="12" cy="5" rx="9" ry="3" />
                                    <path d="M21 12c0 1.66-4.03 3-9 3s-9-1.34-9-3" />
                                    <path d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5" />
                                </svg>
                                <span class="db-label">AlloyDB</span>
                            </div>
                            <div class="search-vectors">
                                <div class="vector-line"></div>
                                <div class="vector-line"></div>
                                <div class="vector-line"></div>
                                <div class="vector-line"></div>
                                <div class="vector-line"></div>
                            </div>
                        </div>
                        <div class="search-status-text">
                            <span class="search-query-label">Search query:</span>
                            <span class="search-query-value"
                                x-text="visionResult ? visionResult.search_query : ''"></span>
                        </div>
                    </div>

                    <!-- Result state -->
                    <div class="supplier-result-card" x-show="supplierResult" x-transition>
                        <div class="supplier-result-header">
                            <div class="match-indicator"></div>
                            <span>Supplier Match Found</span>
                        </div>
                        <div class="supplier-result-details">
                            <div class="supplier-detail-row">
                                <span class="detail-label">Part</span>
                                <span class="detail-value" x-text="supplierResult ? supplierResult.part : ''"></span>
                            </div>
                            <div class="supplier-detail-row">
                                <span class="detail-label">Supplier</span>
                                <span class="detail-value"
                                    x-text="supplierResult ? supplierResult.supplier : ''"></span>
                            </div>
                            <div class="supplier-detail-row">
                                <span class="detail-label">Match Confidence</span>
                                <span class="detail-value confidence-high"
                                    x-text="supplierResult ? supplierResult.confidence : ''"></span>
                            </div>
                        </div>
                        <div class="text-center" style="margin-top: var(--space-5);" x-show="step === 2">
                            <button @click="proceedToOrder()" class="btn btn-primary btn-lg">
                                Continue
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ACT 3: ORDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <section class="act act-order" :class="{ 'active': step === 3 || step === 4 }"
                x-show="step === 3 || step === 4">
                <div class="receipt-card">
                    <div class="receipt-header">
                        <div class="receipt-checkmark">&#10003;</div>
                        <div class="receipt-title">Order Placed</div>
                        <div class="receipt-subtitle">Autonomous procurement complete</div>
                    </div>

                    <div class="receipt-details">
                        <div class="receipt-row">
                            <span class="receipt-label">Order ID</span>
                            <span class="receipt-value order-id" x-text="orderResult ? orderResult.orderId : ''"></span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Part</span>
                            <span class="receipt-value" x-text="supplierResult ? supplierResult.part : ''"></span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Supplier</span>
                            <span class="receipt-value" x-text="supplierResult ? supplierResult.supplier : ''"></span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Quantity</span>
                            <span class="receipt-value" x-text="visionResult ? visionResult.item_count : ''"></span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Confidence</span>
                            <span class="receipt-value confidence-high"
                                x-text="visionResult ? visionResult.confidence : ''"></span>
                        </div>
                    </div>

                    <div class="text-center">
                        <button @click="resetUpload()" class="btn btn-primary btn-lg">
                            Run Another Analysis
                        </button>
                    </div>
                </div>
            </section>

            <!-- Demo Mode: Floating Continue Button -->
            <div class="demo-continue-overlay" x-show="demoWaiting" x-transition>
                <button @click="demoContinue()" class="btn btn-primary btn-lg demo-continue-btn">
                    Continue
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                </button>
            </div>

        </div> <!-- /main-glass-card -->

        <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             RIGHT PANELS (Progress + Code)
             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="right-panels-container" x-show="step > 0" x-transition>

            <!-- Progress bar section -->
            <div class="progress-section floating-status-card" x-show="isProcessing && step === 1">
                <h3 class="panel-title">Analysis Progress</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" :style="`width: ${progressPercent}%`"></div>
                    <span class="progress-percent" x-text="`${progressPercent}%`"></span>
                </div>
                <div class="current-substep">
                    <div class="substep-icon">
                        <span x-show="progressPercent < 30">&#129504;</span>
                        <span x-show="progressPercent >= 30 && progressPercent < 50">&#128221;</span>
                        <span x-show="progressPercent >= 50">&#9889;</span>
                    </div>
                    <div class="substep-text" x-text="currentSubstep"></div>
                </div>
                <div class="code-gen-indicator" x-show="codeGenerating">
                    <div class="code-animation">
                        <div class="code-line"></div>
                        <div class="code-line"></div>
                        <div class="code-line"></div>
                    </div>
                    <span>Generating Python codeâ€¦</span>
                </div>
                <div class="exec-indicator" x-show="codeExecuting">
                    <div class="terminal-animation">
                        <span class="terminal-prompt">$</span>
                        <span class="terminal-cursor"></span>
                    </div>
                    <span>Running detectionâ€¦</span>
                </div>
                <div class="live-logs" x-show="liveLogStream.length > 0">
                    <template x-for="log in liveLogStream.slice(-3)" :key="log.time + log.message">
                        <div class="log-item">
                            <span class="log-time" x-text="log.time"></span>
                            <span class="log-msg" x-text="log.message"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Vision result summary (after analysis complete) -->
            <div class="floating-status-card" x-show="visionResult">
                <h3 class="panel-title">Vision Result</h3>
                <div class="vision-result-summary">
                    <div class="result-stat">
                        <span class="stat-value" x-text="visionResult?.item_count"></span>
                        <span class="stat-label" x-text="visionResult?.item_type"></span>
                    </div>
                    <div class="result-stat">
                        <span class="stat-value" x-text="visionResult?.confidence"></span>
                        <span class="stat-label">confidence</span>
                    </div>
                </div>
            </div>

            <!-- Code viewer -->
            <div class="code-viewer-section floating-status-card" x-show="generatedCode">
                <button class="panel-toggle" @click="showCode = !showCode">
                    <span x-text="showCode ? '&#9662;' : '&#9656;'"></span>
                    Generated Code
                </button>
                <pre class="code-block" x-show="showCode" x-text="generatedCode"></pre>
            </div>

            <!-- Output viewer -->
            <div class="output-viewer-section floating-status-card" x-show="executionOutput">
                <button class="panel-toggle" @click="showOutput = !showOutput">
                    <span x-text="showOutput ? '&#9662;' : '&#9656;'"></span>
                    Execution Output
                </button>
                <pre class="output-block" x-show="showOutput" x-text="executionOutput"></pre>
            </div>

        </div> <!-- /right-panels-container -->

        <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             A2A AGENT DISCOVERY MODAL
             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="agent-discovery-modal" x-show="showAgentDiscovery" x-transition>
            <div class="discovery-backdrop" @click="showAgentDiscovery = false"></div>
            <div class="discovery-container">
                <div class="discovery-header">
                    <h3>Agent Discovery &middot; A2A Protocol</h3>
                    <button class="close-btn" @click="showAgentDiscovery = false">&times;</button>
                </div>

                <!-- Radar animation (shows while searching) -->
                <div class="agent-search-animation" x-show="!discoveredAgent">
                    <div class="search-radar"></div>
                    <div class="search-pulse"></div>
                    <div class="search-label-text">Scanning network...</div>
                </div>

                <!-- Agent card (shows when found â€” with REAL data) -->
                <div class="agent-card" x-show="discoveredAgent" x-transition>
                    <div class="agent-icon">
                        <span x-show="discoveredAgent?.name === 'vision'">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--blue)"
                                stroke-width="1.5">
                                <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </span>
                        <span x-show="discoveredAgent?.name === 'supplier'">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--purple)"
                                stroke-width="1.5">
                                <ellipse cx="12" cy="5" rx="9" ry="3" />
                                <path d="M21 12c0 1.66-4.03 3-9 3s-9-1.34-9-3" />
                                <path d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5" />
                            </svg>
                        </span>
                    </div>
                    <div class="agent-info">
                        <h4 x-text="discoveredAgent?.displayName"></h4>
                        <p x-text="discoveredAgent?.description"></p>
                        <div class="agent-meta">
                            <div class="meta-item">
                                <span class="meta-label">Endpoint</span>
                                <code x-text="discoveredAgent?.endpoint"></code>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Version</span>
                                <code x-text="discoveredAgent?.version"></code>
                            </div>
                            <div class="meta-item" x-show="discoveredAgent?.skills?.length > 0">
                                <span class="meta-label">Skills</span>
                                <div class="meta-skills-block">
                                    <template x-for="skill in (discoveredAgent?.skills || [])" :key="skill.id">
                                        <div class="skill-detail">
                                            <span class="skill-tag" x-text="skill.name"></span>
                                            <div class="skill-tags" x-show="skill.tags?.length > 0">
                                                <template x-for="tag in (skill.tags || [])" :key="tag">
                                                    <span class="skill-micro-tag" x-text="tag"></span>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="meta-item" x-show="discoveredAgent?.inputModes?.length > 0">
                                <span class="meta-label">Input</span>
                                <span class="meta-value" x-text="(discoveredAgent?.inputModes || []).join(', ')"></span>
                            </div>
                            <div class="meta-item" x-show="discoveredAgent?.protocolVersion">
                                <span class="meta-label">Protocol</span>
                                <code x-text="'A2A v' + discoveredAgent?.protocolVersion"></code>
                            </div>
                            <div class="meta-item" x-show="discoveredAgent?.transport">
                                <span class="meta-label">Transport</span>
                                <code x-text="discoveredAgent?.transport"></code>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Streaming</span>
                                <span class="meta-value"
                                    x-text="discoveredAgent?.streaming ? 'Supported' : 'Not supported'"></span>
                            </div>
                        </div>
                    </div>
                    <div class="agent-status">
                        <div class="status-badge success">Connected</div>
                    </div>
                </div>

                <button class="connect-btn" x-show="discoveredAgent" @click="connectToAgent()">
                    Continue
                </button>
            </div>
        </div>

    </div> <!-- /app-container -->

    <script src="/static/app.js"></script>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         DEPLOYER CREDIT POPUP
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="deployer-popup" style="display: none;">
        <div class="deployer-backdrop"></div>
        <div class="deployer-modal">
            <button class="deployer-close" onclick="dismissDeployerPopup()">&times;</button>
            <div class="deployer-emoji">ðŸš€</div>
            <div class="deployer-text">
                <span class="deployer-built">Deployed by</span>
                <span class="deployer-name" id="deployer-name-text"></span>
            </div>
            <div class="deployer-stack">
                Powered by <strong>Gemini 3 Flash</strong> &middot; <strong>AlloyDB AI</strong> &middot; <strong>A2A
                    Protocol</strong>
            </div>
            <div class="deployer-vipassana">
                Completed as part of <a href="https://www.codevipassana.dev/" target="_blank" rel="noopener">Code
                    Vipassana Season 14</a>
            </div>
            <a class="deployer-cta" id="deployer-cta-link" href="#" target="_blank" rel="noopener">
                Try the codelab yourself â†’
            </a>
        </div>
    </div>

    <!-- Persistent bottom badge (shown after popup dismissed) -->
    <div id="deployer-badge" style="display: none;">
        <span id="deployer-badge-text"></span>
        <span class="deployer-badge-sep">&middot;</span>
        <a id="deployer-badge-link" href="#" target="_blank" rel="noopener">Learn how â†’</a>
    </div>

    <style>
        /* Deployer Popup */
        .deployer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 9998;
        }

        .deployer-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: rgba(20, 22, 28, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2.5rem 3rem;
            text-align: center;
            max-width: 440px;
            width: 90%;
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(99, 102, 241, 0.15);
            animation: deployerSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes deployerSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -45%) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .deployer-close {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }

        .deployer-close:hover {
            color: rgba(255, 255, 255, 0.8);
        }

        .deployer-emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .deployer-text {
            margin-bottom: 1rem;
        }

        .deployer-built {
            display: block;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.3rem;
        }

        .deployer-name {
            display: block;
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .deployer-stack {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.8rem;
            line-height: 1.5;
        }

        .deployer-stack strong {
            color: rgba(255, 255, 255, 0.75);
        }

        .deployer-vipassana {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            margin-bottom: 1.5rem;
        }

        .deployer-vipassana a {
            color: #a855f7;
            text-decoration: none;
        }

        .deployer-vipassana a:hover {
            text-decoration: underline;
        }

        .deployer-cta {
            display: inline-block;
            padding: 0.65rem 1.8rem;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .deployer-cta:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        /* Persistent Bottom Badge */
        #deployer-badge {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(20, 22, 28, 0.85);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            padding: 0.5rem 1rem;
            text-align: center;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            animation: badgeSlideUp 0.3s ease-out;
        }

        @keyframes badgeSlideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .deployer-badge-sep {
            margin: 0 0.4rem;
        }

        #deployer-badge a {
            color: #818cf8;
            text-decoration: none;
        }

        #deployer-badge a:hover {
            text-decoration: underline;
        }
    </style>

    <script>
        // Deployer credit popup logic
        (async function () {
            try {
                const res = await fetch('/api/deployer');
                const data = await res.json();
                if (!data.show) return;

                const dismissed = localStorage.getItem('deployer_popup_dismissed');

                // Always show the bottom badge
                const badge = document.getElementById('deployer-badge');
                const badgeText = document.getElementById('deployer-badge-text');
                const badgeLink = document.getElementById('deployer-badge-link');
                badgeText.textContent = `Deployed by ${data.name} Â· Code Vipassana S14`;
                badgeLink.href = data.codelab_url;

                if (dismissed) {
                    // Already dismissed â€” just show badge
                    badge.style.display = 'block';
                    return;
                }

                // Show popup
                const popup = document.getElementById('deployer-popup');
                document.getElementById('deployer-name-text').textContent = data.name;
                const ctaLink = document.getElementById('deployer-cta-link');
                ctaLink.href = data.codelab_url;
                popup.style.display = 'block';

                // Auto-dismiss after 10 seconds
                setTimeout(() => dismissDeployerPopup(), 10000);
            } catch (e) {
                // Silently fail â€” no popup in dev mode
            }
        })();

        function dismissDeployerPopup() {
            const popup = document.getElementById('deployer-popup');
            if (popup) popup.style.display = 'none';
            localStorage.setItem('deployer_popup_dismissed', 'true');
            const badge = document.getElementById('deployer-badge');
            if (badge) badge.style.display = 'block';
        }
    </script>

</body>

</html>