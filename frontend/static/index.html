<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomous Supply Chain Control Tower</title>
    <meta name="theme-color" content="#08090A">

    <link rel="stylesheet" href="/static/styles.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="appState()">

    <!-- ═══════════════════════════════════════════
         STICKY RESULTS BAR (builds up as data arrives)
         ═══════════════════════════════════════════ -->
    <div class="results-header" :class="{'visible': visionResult !== null}">
        <div class="results-header-content">
            <div class="result-item">
                <span class="result-label">Count</span>
                <span class="result-value highlight" x-text="visionResult?.item_count || '—'"></span>
            </div>
            <div class="result-item">
                <span class="result-label">Type</span>
                <span class="result-value" x-text="visionResult?.item_type || '—'"></span>
            </div>
            <div class="result-item">
                <span class="result-label">Confidence</span>
                <span class="result-value" x-text="visionResult?.confidence || '—'"></span>
            </div>
            <div class="result-item" x-show="supplierResult">
                <span class="result-label">Supplier</span>
                <span class="result-value" x-text="supplierResult?.supplier || '—'"></span>
            </div>
            <div class="result-item" x-show="orderResult">
                <span class="result-label">Order</span>
                <span class="result-value" style="color: var(--green);" x-text="orderResult?.orderId || '—'"></span>
            </div>
        </div>
        <button @click="resetUpload()" class="btn btn-sm" style="background: var(--surface-3); color: var(--text-80);">
            New Analysis
        </button>
    </div>

    <!-- ═══════════════════════════════════════════
         FIXED CONTROLS (top right)
         ═══════════════════════════════════════════ -->
    <div class="fixed-controls no-print">
        <button @click="toggleAudio()" class="mute-toggle" :title="audioEnabled ? 'Mute' : 'Unmute'">
            <span x-show="audioEnabled">&#x1f50a;</span>
            <span x-show="!audioEnabled">&#x1f507;</span>
        </button>
        <div class="connection-status">
            <div class="connection-dot" :class="wsConnected ? 'connected' : 'disconnected'"></div>
            <span x-text="wsConnected ? 'Live' : 'Offline'"></span>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════
         HEADER (hidden when results header visible)
         ═══════════════════════════════════════════ -->
    <header :class="{'header-hidden': visionResult}">
        <h1 class="hero-title">Autonomous Supply Chain Control Tower</h1>
        <p class="hero-subtitle">Gemini 3 Flash &middot; AlloyDB AI &middot; A2A Protocol</p>
    </header>

    <!-- ═══════════════════════════════════════════
         MAIN CONTENT AREA
         ═══════════════════════════════════════════ -->
    <div class="app-container" :class="{'has-panels': step > 0}">

        <!-- ──────────────────────────────────
             LEFT PANELS (Agent Activity + Workflow)
             ────────────────────────────────── -->
        <div class="left-panels-container" x-show="step > 0" x-transition>

            <!-- Workflow timeline -->
            <div class="workflow-panel floating-status-card">
                <div class="progress-timeline">
                    <h3 class="panel-title">Workflow</h3>
                    <div class="timeline-steps">
                        <div class="timeline-step" :class="{'active': step >= 0, 'completed': step > 0}">
                            <div class="step-indicator"></div>
                            <span>Upload Image</span>
                        </div>
                        <div class="timeline-step" :class="{'active': step >= 1, 'completed': step > 1}">
                            <div class="step-indicator"></div>
                            <span>Vision Analysis</span>
                        </div>
                        <div class="timeline-step" :class="{'active': step >= 2, 'completed': step > 2}">
                            <div class="step-indicator"></div>
                            <span>Supplier Match</span>
                        </div>
                        <div class="timeline-step" :class="{'active': step >= 3, 'completed': step >= 4}">
                            <div class="step-indicator"></div>
                            <span>Place Order</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent activity -->
            <div class="agent-panel floating-status-card" :class="{'tint-vision': step === 1, 'tint-memory': step === 2, 'tint-action': step >= 3}">
                <h3 class="panel-title">Agent Activity</h3>
                <div class="agent-activity">
                    <div class="activity-text" x-text="orchestratorText || 'System ready'"></div>
                    <div class="activity-indicator" x-show="isProcessing">
                        <div class="pulse-dot"></div>
                        <div class="pulse-dot"></div>
                        <div class="pulse-dot"></div>
                    </div>
                </div>
            </div>

        </div> <!-- /left-panels-container -->

        <!-- ──────────────────────────────────
             MAIN CARD (center column)
             ────────────────────────────────── -->
        <div class="main-glass-card">

            <!-- ACT 0: UPLOAD ─────────────────── -->
            <section class="act act-upload" :class="{ 'active': step === 0 }" x-show="step === 0">

                <!-- Sample images FIRST — prominent, above fold -->
                <div x-show="sampleImages.length > 0 && !uploadedImage" class="samples-section">
                    <div class="samples-header">
                        <span class="samples-label">Quick start</span>
                        <div class="samples-line"></div>
                    </div>
                    <div class="samples-grid">
                        <template x-for="img in sampleImages" :key="img.name">
                            <div class="sample-card" @click="selectSampleImage(img.name)">
                                <img :src="`/api/test-image/${img.name}`" :alt="img.name" loading="eager">
                                <div class="sample-overlay">
                                    <span class="sample-action">Analyze this image</span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Upload area (compact) -->
                <div class="upload-area"
                     :class="{'drag-over': isDragging, 'has-image': uploadedImage}"
                     @dragover.prevent="isDragging = true"
                     @dragleave.prevent="isDragging = false"
                     @drop.prevent="handleDrop($event)">

                    <template x-if="!uploadedImage">
                        <label for="file-upload" class="upload-label">
                            <svg class="upload-icon" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <span class="upload-text">
                                <span class="upload-link">Upload a file</span>
                                or drag and drop
                            </span>
                            <span class="upload-hint">PNG, JPG, JPEG up to 10MB</span>
                            <input id="file-upload" type="file" style="display: none;" accept="image/*" @change="handleFileSelect($event)">
                        </label>
                    </template>

                    <template x-if="uploadedImage">
                        <div style="position: relative;">
                            <img :src="uploadedImage" alt="Uploaded warehouse image" class="uploaded-preview">
                            <button @click="resetUpload()" class="remove-image-btn">
                                <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </template>
                </div>

                <!-- Start button (only shows when image uploaded) -->
                <div class="text-center" x-show="uploadedImage" style="margin-top: var(--space-5);">
                    <button @click="startAnalysis()"
                            :disabled="!uploadedImage || isProcessing"
                            class="btn btn-primary btn-lg">
                        <template x-if="!isProcessing">
                            <span>Initiate Autonomous Workflow</span>
                        </template>
                        <template x-if="isProcessing">
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="spinner"></span>
                                Processing…
                            </span>
                        </template>
                    </button>
                </div>

                <!-- Value proposition -->
                <div class="value-props" x-show="!uploadedImage">
                    <div class="value-prop">
                        <div class="prop-icon" style="color: var(--blue);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        </div>
                        <div>
                            <div class="prop-title">Count with Gemini 3 Flash</div>
                            <div class="prop-desc">Code execution counts boxes via OpenCV</div>
                        </div>
                    </div>
                    <div class="value-prop">
                        <div class="prop-icon" style="color: var(--purple);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                        </div>
                        <div>
                            <div class="prop-title">Match via AlloyDB ScaNN</div>
                            <div class="prop-desc">Vector search across 1M+ supplier parts</div>
                        </div>
                    </div>
                    <div class="value-prop">
                        <div class="prop-icon" style="color: var(--green);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <div>
                            <div class="prop-title">Order via A2A Protocol</div>
                            <div class="prop-desc">Agent-to-agent autonomous procurement</div>
                        </div>
                    </div>
                </div>

            </section>

            <!-- ACT 1: VISION ─────────────────── -->
            <section class="act act-vision" :class="{ 'active': step === 1 }" x-show="step === 1">
                <div class="image-stage">
                    <img :src="uploadedImage" alt="Analyzing…">

                    <!-- Scan line -->
                    <div class="scan-overlay" x-show="!visionResult">
                        <div class="scan-line"></div>
                    </div>

                    <!-- Thought stream -->
                    <div class="thought-overlay" x-show="currentThought && !visionResult">
                        <span class="thought-text" x-text="currentThought"></span>
                        <span class="thought-cursor"></span>
                    </div>

                    <!-- Bounding boxes overlay (Gemini spatial understanding) -->
                    <div class="bbox-overlay" x-show="visionResult && boundingBoxes.length > 0">
                        <template x-for="(box, idx) in boundingBoxes" :key="idx">
                            <div class="bbox-rect"
                                 :style="`top: ${box.box_2d[0] / 10}%; left: ${box.box_2d[1] / 10}%; height: ${(box.box_2d[2] - box.box_2d[0]) / 10}%; width: ${(box.box_2d[3] - box.box_2d[1]) / 10}%; animation-delay: ${idx * 60}ms;`">
                                <span class="bbox-label" x-text="box.label"></span>
                            </div>
                        </template>
                    </div>

                    <!-- Result badge -->
                    <div x-show="visionResult" class="result-container">
                        <div class="count-badge">
                            <div class="badge-indicator" :class="{'confirmed': visionResult?.hasCodeExecution, 'estimated': !visionResult?.hasCodeExecution}">
                                <span x-show="visionResult?.hasCodeExecution">&#10003;</span>
                                <span x-show="!visionResult?.hasCodeExecution">~</span>
                            </div>
                            <div class="badge-content">
                                <div class="badge-count" x-text="visionResult ? `${visionResult.item_count} ${visionResult.item_type}` : ''"></div>
                                <div class="badge-label" x-text="visionResult?.hasCodeExecution ? 'Code-Verified' : 'Estimated'"></div>
                            </div>
                        </div>
                        <div class="count-summary" x-text="visionResult ? visionResult.summary : ''"></div>
                    </div>
                </div>
            </section>

            <!-- ACT 2: SUPPLIER MATCH ─────────── -->
            <section class="act act-memory" :class="{ 'active': step === 2 }" x-show="step === 2">
                <!-- Transition header -->
                <div class="act-transition-header">
                    <div class="transition-badge vision-done">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"/></svg>
                        <span x-text="visionResult ? `${visionResult.item_count} ${visionResult.item_type} detected` : ''"></span>
                    </div>
                    <div class="transition-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
                    </div>
                    <div class="transition-badge supplier-active">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                        <span>Finding supplier match</span>
                    </div>
                </div>

                <!-- Supplier search visualization -->
                <div class="supplier-search-container">
                    <!-- Searching state -->
                    <div class="vector-search-viz" x-show="!supplierResult">
                        <div class="search-animation-container">
                            <div class="db-icon-container">
                                <svg class="db-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4.03 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5"/></svg>
                                <span class="db-label">AlloyDB</span>
                            </div>
                            <div class="search-vectors">
                                <div class="vector-line"></div>
                                <div class="vector-line"></div>
                                <div class="vector-line"></div>
                                <div class="vector-line"></div>
                                <div class="vector-line"></div>
                            </div>
                        </div>
                        <div class="search-status-text">
                            <span class="search-query-label">Search query:</span>
                            <span class="search-query-value" x-text="visionResult ? visionResult.search_query : ''"></span>
                        </div>
                    </div>

                    <!-- Result state -->
                    <div class="supplier-result-card" x-show="supplierResult" x-transition>
                        <div class="supplier-result-header">
                            <div class="match-indicator"></div>
                            <span>Supplier Match Found</span>
                        </div>
                        <div class="supplier-result-details">
                            <div class="supplier-detail-row">
                                <span class="detail-label">Part</span>
                                <span class="detail-value" x-text="supplierResult ? supplierResult.part : ''"></span>
                            </div>
                            <div class="supplier-detail-row">
                                <span class="detail-label">Supplier</span>
                                <span class="detail-value" x-text="supplierResult ? supplierResult.supplier : ''"></span>
                            </div>
                            <div class="supplier-detail-row">
                                <span class="detail-label">Match Confidence</span>
                                <span class="detail-value confidence-high" x-text="supplierResult ? supplierResult.confidence : ''"></span>
                            </div>
                        </div>
                        <div class="text-center" style="margin-top: var(--space-5);" x-show="step === 2">
                            <button @click="proceedToOrder()" class="btn btn-primary btn-lg">
                                Proceed to Order
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ACT 3: ORDER ──────────────────── -->
            <section class="act act-order" :class="{ 'active': step === 3 || step === 4 }" x-show="step === 3 || step === 4">
                <div class="receipt-card">
                    <div class="receipt-header">
                        <div class="receipt-checkmark">&#10003;</div>
                        <div class="receipt-title">Order Placed</div>
                        <div class="receipt-subtitle">Autonomous procurement complete</div>
                    </div>

                    <div class="receipt-details">
                        <div class="receipt-row">
                            <span class="receipt-label">Order ID</span>
                            <span class="receipt-value order-id" x-text="orderResult ? orderResult.orderId : ''"></span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Part</span>
                            <span class="receipt-value" x-text="supplierResult ? supplierResult.part : ''"></span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Supplier</span>
                            <span class="receipt-value" x-text="supplierResult ? supplierResult.supplier : ''"></span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Quantity</span>
                            <span class="receipt-value" x-text="visionResult ? visionResult.item_count : ''"></span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Confidence</span>
                            <span class="receipt-value confidence-high" x-text="visionResult ? visionResult.confidence : ''"></span>
                        </div>
                    </div>

                    <div class="text-center">
                        <button @click="resetUpload()" class="btn btn-primary btn-lg">
                            Run Another Analysis
                        </button>
                    </div>
                </div>
            </section>

        </div> <!-- /main-glass-card -->

        <!-- ──────────────────────────────────
             RIGHT PANELS (Progress + Code)
             ────────────────────────────────── -->
        <div class="right-panels-container" x-show="step > 0" x-transition>

            <!-- Progress bar section -->
            <div class="progress-section floating-status-card" x-show="isProcessing && step === 1">
                <h3 class="panel-title">Analysis Progress</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" :style="`width: ${progressPercent}%`"></div>
                    <span class="progress-percent" x-text="`${progressPercent}%`"></span>
                </div>
                <div class="current-substep">
                    <div class="substep-icon">
                        <span x-show="progressPercent < 30">&#129504;</span>
                        <span x-show="progressPercent >= 30 && progressPercent < 50">&#128221;</span>
                        <span x-show="progressPercent >= 50">&#9889;</span>
                    </div>
                    <div class="substep-text" x-text="currentSubstep"></div>
                </div>
                <div class="code-gen-indicator" x-show="codeGenerating">
                    <div class="code-animation">
                        <div class="code-line"></div>
                        <div class="code-line"></div>
                        <div class="code-line"></div>
                    </div>
                    <span>Generating Python code…</span>
                </div>
                <div class="exec-indicator" x-show="codeExecuting">
                    <div class="terminal-animation">
                        <span class="terminal-prompt">$</span>
                        <span class="terminal-cursor"></span>
                    </div>
                    <span>Running detection…</span>
                </div>
                <div class="live-logs" x-show="liveLogStream.length > 0">
                    <template x-for="log in liveLogStream.slice(-3)" :key="log.time + log.message">
                        <div class="log-item">
                            <span class="log-time" x-text="log.time"></span>
                            <span class="log-msg" x-text="log.message"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Vision result summary (after analysis complete) -->
            <div class="floating-status-card" x-show="visionResult">
                <h3 class="panel-title">Vision Result</h3>
                <div class="vision-result-summary">
                    <div class="result-stat">
                        <span class="stat-value" x-text="visionResult?.item_count"></span>
                        <span class="stat-label" x-text="visionResult?.item_type"></span>
                    </div>
                    <div class="result-stat">
                        <span class="stat-value" x-text="visionResult?.confidence"></span>
                        <span class="stat-label">confidence</span>
                    </div>
                </div>
            </div>

            <!-- Code viewer -->
            <div class="code-viewer-section floating-status-card" x-show="generatedCode">
                <button class="panel-toggle" @click="showCode = !showCode">
                    <span x-text="showCode ? '&#9662;' : '&#9656;'"></span>
                    Generated Code
                </button>
                <pre class="code-block" x-show="showCode" x-text="generatedCode"></pre>
            </div>

            <!-- Output viewer -->
            <div class="output-viewer-section floating-status-card" x-show="executionOutput">
                <button class="panel-toggle" @click="showOutput = !showOutput">
                    <span x-text="showOutput ? '&#9662;' : '&#9656;'"></span>
                    Execution Output
                </button>
                <pre class="output-block" x-show="showOutput" x-text="executionOutput"></pre>
            </div>

        </div> <!-- /right-panels-container -->

        <!-- ──────────────────────────────────
             A2A AGENT DISCOVERY MODAL
             ────────────────────────────────── -->
        <div class="agent-discovery-modal" x-show="showAgentDiscovery" x-transition>
            <div class="discovery-backdrop" @click="showAgentDiscovery = false"></div>
            <div class="discovery-container">
                <div class="discovery-header">
                    <h3>Agent Discovery &middot; A2A Protocol</h3>
                    <button class="close-btn" @click="showAgentDiscovery = false">&times;</button>
                </div>

                <!-- Radar animation (shows while searching) -->
                <div class="agent-search-animation" x-show="!discoveredAgent">
                    <div class="search-radar"></div>
                    <div class="search-pulse"></div>
                    <div class="search-label-text">Scanning network...</div>
                </div>

                <!-- Agent card (shows when found — with REAL data) -->
                <div class="agent-card" x-show="discoveredAgent" x-transition>
                    <div class="agent-icon">
                        <span x-show="discoveredAgent?.name === 'vision'">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="1.5"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        </span>
                        <span x-show="discoveredAgent?.name === 'supplier'">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="1.5"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4.03 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5"/></svg>
                        </span>
                    </div>
                    <div class="agent-info">
                        <h4 x-text="discoveredAgent?.displayName"></h4>
                        <p x-text="discoveredAgent?.description"></p>
                        <div class="agent-meta">
                            <div class="meta-item">
                                <span class="meta-label">Endpoint</span>
                                <code x-text="discoveredAgent?.endpoint"></code>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Version</span>
                                <code x-text="discoveredAgent?.version"></code>
                            </div>
                            <div class="meta-item" x-show="discoveredAgent?.skills?.length > 0">
                                <span class="meta-label">Skills</span>
                                <div class="meta-skills-block">
                                    <template x-for="skill in (discoveredAgent?.skills || [])" :key="skill.id">
                                        <div class="skill-detail">
                                            <span class="skill-tag" x-text="skill.name"></span>
                                            <div class="skill-tags" x-show="skill.tags?.length > 0">
                                                <template x-for="tag in (skill.tags || [])" :key="tag">
                                                    <span class="skill-micro-tag" x-text="tag"></span>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="meta-item" x-show="discoveredAgent?.inputModes?.length > 0">
                                <span class="meta-label">Input</span>
                                <span class="meta-value" x-text="(discoveredAgent?.inputModes || []).join(', ')"></span>
                            </div>
                            <div class="meta-item" x-show="discoveredAgent?.protocolVersion">
                                <span class="meta-label">Protocol</span>
                                <code x-text="'A2A v' + discoveredAgent?.protocolVersion"></code>
                            </div>
                            <div class="meta-item" x-show="discoveredAgent?.transport">
                                <span class="meta-label">Transport</span>
                                <code x-text="discoveredAgent?.transport"></code>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Streaming</span>
                                <span class="meta-value" x-text="discoveredAgent?.streaming ? 'Supported' : 'Not supported'"></span>
                            </div>
                        </div>
                    </div>
                    <div class="agent-status">
                        <div class="status-badge success">Connected</div>
                    </div>
                </div>

                <button class="connect-btn" x-show="discoveredAgent" @click="connectToAgent()">
                    Continue
                </button>
            </div>
        </div>

    </div> <!-- /app-container -->

    <script src="/static/app.js"></script>

</body>
</html>
